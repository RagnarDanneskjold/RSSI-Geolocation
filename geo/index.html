<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>Google Maps - pygmaps </title>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="maplabel-compiled.js"></script><script type="text/javascript">
	function initialize() {
		var centerlatlng = new google.maps.LatLng(46.518394, 6.568469);
		var myOptions = {
			zoom: 16,
			center: centerlatlng,
			mapTypeId: google.maps.MapTypeId.SATELLITE
		};
		var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		var images = []
		
		for (var i = 0; i < 360; i++) { 
			images[i] = "images/plane"+i+".png"
		}
		
		var markers = {};
		
        var ws = new WebSocket("ws://localhost:8888/ws");
		ws.onmessage = function(evt) {
			if (evt.data.indexOf('[p]') == 0) {
				var input = evt.data.substring(3);
				var opt = input.split('\t');
				var plane = opt[0];
				var lat = opt[1];
				var lon = opt[2];
				var angle = (180 - parseInt(opt[3])) % 360;
				var oldMarker = markers[plane]
				if (oldMarker !== undefined) {
					markers[plane].setMap(null)
				}
				markers[plane] = new MapLabel({
					position: new google.maps.LatLng(lat, lon),
					map: map,
					fontSize: 12,
					align: "center"
				});
				var image = {
					url: images[angle],
					size: new google.maps.Size(64, 64),
					origin: new google.maps.Point(0,0),
					anchor: new google.maps.Point(32, 32)
				};
                
				var marker = new google.maps.Marker({
					icon: image
				});
				marker.bindTo("map", markers[plane]);
				marker.bindTo("position", markers[plane]);
				marker.setDraggable(true);
				
			} else if (evt.data.indexOf('[u]') == 0) {
				var input = evt.data.substring(3, 0);
				var opt = input.split('\t');
				var user = opt[0];
				var lat = opt[1];
				var lon = opt[2];
				
				var oldMarker = markers[user]
				if (oldMarker !== undefined) {
					markers[user].setMap(null)
				}
				markers[user] = new MapLabel({
					text: user,
					position: new google.maps.LatLng(lat, lon),
					map: map,
					fontSize: 12,
					align: "center"
				})
				var marker = new google.maps.Marker;
				marker.bindTo("map", markers[user]);
				marker.bindTo("position", markers[user]);
				marker.setDraggable(true);
			} else {
					console.log('no regex : ' + evt.data);
			}
			
			
		}
		ws.onclose = function(evt) { alert("Connection close"); };
 
          ws.onopen = function(evt) { 
				

		  }
        };


</script>
</head>
<body style="margin:0px; padding:0px;" onload="initialize()">
	<div id="map_canvas" style="width: 100%; height: 100%;"></div>
</body>
</html>
